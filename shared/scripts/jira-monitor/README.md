# Jira Monitor

Automation that polls Jira for **To Do** tickets assigned to you and kicks off Cursor Agent workflows in the backend and/or frontend repos. Two scripts work together: **poll-jira.sh** discovers tickets and invokes **check-jira.sh** for each; **check-jira.sh** validates the ticket, generates a branch name, checks if the branch already exists via GitHub CLI, uses the **determine-repos** skill to decide backend/frontend/both, then runs backend then frontend implementation sequentially.

## Prerequisites

- **Shell:** zsh (scripts use `#!/bin/zsh`)
- **Tools:** `jq` (for Jira response parsing), `gh` (GitHub CLI for branch/PR checks), Cursor Agent CLI (`agent` binary)
- **Environment variables** (e.g. in `~/.zshrc`):
  - `JIRA_URL` – Jira base URL (e.g. `https://your-domain.atlassian.net`)
  - `JIRA_EMAIL` – Your Jira user email
  - `JIRA_API_TOKEN` – Jira API token (create in Jira account settings)
  - When using **LaunchAgent** (e.g. `setup-launchd.sh`), ensure these are **exported** in `~/.zshrc` (e.g. `export JIRA_URL=...`) so the agent receives them when running headless and can update Jira status via the REST API.
- **Paths:** Edit the CONFIG section at the top of `check-jira.sh` (and optionally `poll-jira.sh`) if your backend/frontend repos, GitHub org, or agent binary live elsewhere:
  - `BACKEND_REPO`, `FRONTEND_REPO`, `GH_ORG`, `AGENT_BIN`

The script expects the **ai repo** layout: this directory lives under `ai/shared/scripts/jira-monitor/`, and the determine-repos skill runs with the ai repo root so it can read `backend/.claude/indicators.md` and `frontend/.claude/indicators.md`.

## Scripts

| Script | Purpose |
|--------|--------|
| **poll-jira.sh** | Scheduled entry point. Runs every 5 min (via launchd/cron). Queries Jira for your To Do tickets, then for each ticket invokes `check-jira.sh <TICKET_KEY>`. Holds a lock to prevent overlapping runs. Use `poll-jira.sh --dry-run` to validate config. |
| **check-jira.sh** | Single-ticket orchestrator. Usage: `check-jira.sh <TICKET_KEY>`. Validates ticket is assigned to you and in To Do (JQL), generates branch name, checks if branch exists in auditboard-backend/auditboard-frontend via `gh`; if it exists, opens PR or branch page and exits. Otherwise runs determine-repos skill, then backend agent then frontend agent (start-jira-work) sequentially. |
| **generate-branch-name.sh** | Given a Jira ticket key and summary, outputs the standardized branch name (same rules as the generate-branch-name skill). Used by check-jira.sh so the pipeline does not invoke the agent for branch names. |
| **setup-launchd.sh** | Validate config with poll-jira.sh --dry-run, then install a LaunchAgent so `poll-jira.sh` runs every 5 minutes in your graphical session (recommended on macOS). |
| **setup-cron.sh** | Validate config with poll-jira.sh --dry-run, then install a cron job so `poll-jira.sh` runs every 5 minutes. On macOS use setup-launchd.sh instead. |

## Running

**Process all To Do tickets (scheduled style):**

```bash
cd /path/to/ai/shared/scripts/jira-monitor
./poll-jira.sh
```

If you have no To Do tickets assigned, it exits after one Jira query. If you do, it processes each ticket by calling `check-jira.sh` for each. A lock file prevents overlapping runs.

**Process a single ticket (manual):**

```bash
./check-jira.sh SOX-84649
```

**Dry-run (validate only):**

```bash
./poll-jira.sh --dry-run
```

Checks Jira credentials, gh CLI, check-jira.sh, determine-repos skill, branch script, and ai repo layout. Does not query for tickets or launch any agents. Use this before setting up launchd/cron or when debugging.

## Setting up the schedule

**macOS (recommended):**

```bash
./setup-launchd.sh
```

This runs `poll-jira.sh --dry-run`, then installs a LaunchAgent so `poll-jira.sh` runs every 5 minutes in your user session. A lock file in poll-jira.sh prevents overlapping runs.

**Cron (e.g. Linux):**

```bash
./setup-cron.sh
```

This runs `poll-jira.sh --dry-run`, then adds a cron job: every 5 minutes, `source ~/.zshrc` then `poll-jira.sh`, with output appended to `logs/cron.log`.

**To remove the cron job later:**

```bash
crontab -l | grep -v 'poll-jira.sh' | crontab -
```

## Logs

- **Cron/LaunchAgent output:** `logs/cron.log` (stdout/stderr from each scheduled run)
- **Per-ticket, per-repo:** `logs/<timestamp>_<TICKET-KEY>_backend.log`, `..._frontend.log` (agent output when a repo is run)

## How it fits with the rest of the repo

- **Branch name (monitor):** Generated by `generate-branch-name.sh` from the Jira key and summary. No agent call.
- **Branch name (manual):** The `generate-branch-name` skill is used when an agent needs a branch name and `BRANCH_NAME` is not set (e.g. manual start-jira-work).
- **Shared skills** (ai repo): `shared/.claude/skills/determine-repos/` decides which repos need work; `shared/.claude/skills/generate-branch-name/` documents the same branch naming rules for agent use.
- **Repo skills:** Backend and frontend each have `start-jira-work` and `.claude/indicators.md`; check-jira.sh launches the agent in the corresponding repo so it runs that workflow.

For more detail, see the comments inside `poll-jira.sh`, `check-jira.sh`, and the setup scripts.
